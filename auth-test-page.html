<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Flow Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #333;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-column {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-column h2 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background-color: #0056b3;
        }
        
        .button.success {
            background-color: #28a745;
        }
        
        .button.danger {
            background-color: #dc3545;
        }
        
        .button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .debug-window {
            background: #1e1e1e;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            height: 400px;
            overflow-y: auto;
        }
        
        .debug-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #666;
        }
        
        .debug-entry.success {
            border-left-color: #28a745;
        }
        
        .debug-entry.error {
            border-left-color: #dc3545;
        }
        
        .debug-entry.info {
            border-left-color: #17a2b8;
        }
        
        .debug-entry .timestamp {
            color: #888;
            margin-right: 10px;
        }
        
        .placeholder {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }
        
        .test-step {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .test-step.complete {
            background: #d4edda;
        }
        
        .test-step.failed {
            background: #f8d7da;
        }
        
        .step-status {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Authentication Flow Test Page</h1>
        
        <div class="test-grid">
            <!-- API Key Column -->
            <div class="test-column">
                <h2>API Key Authentication</h2>
                
                <div class="form-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" id="apiKey" value="test-key-123" placeholder="Enter API key">
                </div>
                
                <div class="form-group">
                    <label for="apiUrl">API URL:</label>
                    <input type="text" id="apiUrl" value="http://localhost:3009/v1" placeholder="API base URL">
                </div>
                
                <button class="button" onclick="testApiKeyFlow()">Test Complete Flow</button>
                <button class="button success" onclick="testApiKeyStep('setup')">1. Setup</button>
                <button class="button success" onclick="testApiKeyStep('clear')">2. Clear Auth</button>
                <button class="button success" onclick="testApiKeyStep('store')">3. Store Key</button>
                <button class="button success" onclick="testApiKeyStep('verify')">4. Verify Storage</button>
                <button class="button success" onclick="testApiKeyStep('request')">5. Test Request</button>
                <button class="button success" onclick="testApiKeyStep('auth-request')">6. Test Auth Endpoint</button>
                
                <div id="apiKeyStatus"></div>
                
                <div class="test-steps" id="apiKeySteps" style="margin-top: 20px;">
                    <h4>Test Steps:</h4>
                    <div class="test-step" id="step-setup">
                        <span>Setup Environment</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="step-clear">
                        <span>Clear Existing Auth</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="step-store">
                        <span>Store API Key</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="step-verify">
                        <span>Verify Storage</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="step-request">
                        <span>Test API Request</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="step-auth-request">
                        <span>Test Authenticated Endpoint</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                </div>
            </div>
            
            <!-- JWT Column -->
            <div class="test-column">
                <h2>JWT Authentication</h2>
                
                <div class="form-group">
                    <label for="jwtEmail">Email:</label>
                    <input type="email" id="jwtEmail" value="testauth@example.com" placeholder="Enter email">
                </div>
                
                <div class="form-group">
                    <label for="jwtPassword">Password:</label>
                    <input type="password" id="jwtPassword" value="TestPass123!" placeholder="Enter password">
                </div>
                
                <div class="form-group">
                    <label for="jwtProjectId">Project ID (optional):</label>
                    <input type="text" id="jwtProjectId" value="335395d6-b489-4a32-bda2-aecfe7726d8f" placeholder="Project ID">
                </div>
                
                <button class="button" onclick="testJwtFlow()">Test Complete Flow</button>
                <button class="button success" onclick="testJwtStep('clear')">1. Clear Auth</button>
                <button class="button success" onclick="testJwtStep('login')">2. Login (Correct)</button>
                <button class="button danger" onclick="testJwtStep('login-wrong')">2b. Login (Wrong Pass)</button>
                <button class="button success" onclick="testJwtStep('verify-token')">3. Verify Token</button>
                <button class="button success" onclick="testJwtStep('profile')">4. Get Profile</button>
                <button class="button success" onclick="testJwtStep('auth-test')">5. Test Auth</button>
                <button class="button danger" onclick="testJwtStep('logout')">6. Logout</button>
                
                <div id="jwtStatus"></div>
                
                <div class="test-steps" style="margin-top: 20px;">
                    <h4>Test Steps:</h4>
                    <div class="test-step" id="jwt-step-clear">
                        <span>Clear Auth</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="jwt-step-login">
                        <span>Login</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="jwt-step-verify-token">
                        <span>Verify Token</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="jwt-step-profile">
                        <span>Get Profile</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="jwt-step-auth-test">
                        <span>Test Authorized Request</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="jwt-step-logout">
                        <span>Logout</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                </div>
            </div>
            
            <!-- Azure AD Column -->
            <div class="test-column">
                <h2>Azure AD Authentication</h2>
                
                <div class="form-group">
                    <label for="azureTenantId">Tenant ID:</label>
                    <input type="text" id="azureTenantId" placeholder="Enter Azure AD Tenant ID">
                </div>
                
                <div class="form-group">
                    <label for="azureClientId">Client ID:</label>
                    <input type="text" id="azureClientId" placeholder="Enter Azure AD Client ID">
                </div>
                
                <div class="form-group">
                    <label for="azureRedirectUri">Redirect URI:</label>
                    <input type="text" id="azureRedirectUri" value="http://localhost:5173/auth/callback" placeholder="Redirect URI">
                </div>
                
                <div class="form-group">
                    <label for="azureAuthCode">Auth Code (from callback):</label>
                    <input type="text" id="azureAuthCode" placeholder="Paste authorization code here">
                </div>
                
                <button class="button" onclick="testAzureFlow()">Test Complete Flow</button>
                <button class="button success" onclick="testAzureStep('clear')">1. Clear Auth</button>
                <button class="button success" onclick="testAzureStep('auth-url')">2. Generate Auth URL</button>
                <button class="button success" onclick="testAzureStep('exchange')">3. Exchange Code</button>
                <button class="button success" onclick="testAzureStep('verify')">4. Verify Token</button>
                <button class="button success" onclick="testAzureStep('profile')">5. Get Profile</button>
                
                <div id="azureStatus"></div>
                
                <div id="azureAuthUrl" style="margin-top: 10px; display: none;">
                    <p style="font-weight: bold;">Authorization URL:</p>
                    <textarea id="authUrlText" style="width: 100%; height: 60px; font-size: 11px;" readonly></textarea>
                    <button class="button" onclick="copyAuthUrl()">Copy URL</button>
                    <button class="button" onclick="openAuthUrl()">Open in Browser</button>
                </div>
                
                <div class="test-steps" style="margin-top: 20px;">
                    <h4>Test Steps:</h4>
                    <div class="test-step" id="azure-step-clear">
                        <span>Clear Auth</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="azure-step-auth-url">
                        <span>Generate Auth URL</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="azure-step-exchange">
                        <span>Exchange Code for Token</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="azure-step-verify">
                        <span>Verify Token</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                    <div class="test-step" id="azure-step-profile">
                        <span>Get Profile</span>
                        <span class="step-status">‚è≥</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Debug Window -->
        <h2>Debug Output</h2>
        <div class="debug-window" id="debugWindow">
            <div class="debug-entry info">
                <span class="timestamp">[00:00:00]</span>
                Test page loaded. Ready to test authentication flows.
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
            <button class="button danger" onclick="clearDebugLog()">Clear Debug Log</button>
            <button class="button" onclick="copyDebugLog()">Copy Debug Log</button>
            <button class="button" onclick="downloadDebugLog()">Download Debug Log</button>
        </div>
    </div>
    
    <script>
        // Debug logging
        function log(message, type = 'info') {
            const debugWindow = document.getElementById('debugWindow');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `debug-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            debugWindow.appendChild(entry);
            debugWindow.scrollTop = debugWindow.scrollHeight;
        }
        
        function updateStepStatus(stepId, status) {
            const step = document.getElementById(stepId);
            if (step) {
                step.classList.remove('complete', 'failed');
                const statusIcon = step.querySelector('.step-status');
                
                if (status === 'complete') {
                    step.classList.add('complete');
                    statusIcon.textContent = '‚úÖ';
                } else if (status === 'failed') {
                    step.classList.add('failed');
                    statusIcon.textContent = '‚ùå';
                } else if (status === 'running') {
                    statusIcon.textContent = '‚è≥';
                } else {
                    statusIcon.textContent = '‚è≥';
                }
            }
        }
        
        function showStatus(elementId, message, type = 'info') {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
        
        // API Key test functions
        async function testApiKeyStep(step) {
            const apiKey = document.getElementById('apiKey').value;
            const apiUrl = document.getElementById('apiUrl').value;
            
            log(`Starting API Key test step: ${step}`, 'info');
            
            switch(step) {
                case 'setup':
                    updateStepStatus('step-setup', 'running');
                    log('Setting up test environment...', 'info');
                    log(`API URL: ${apiUrl}`, 'info');
                    log(`API Key: ${apiKey.substring(0, 10)}...`, 'info');
                    updateStepStatus('step-setup', 'complete');
                    break;
                    
                case 'clear':
                    updateStepStatus('step-clear', 'running');
                    log('Clearing existing authentication...', 'info');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('apiKey');
                    log('localStorage cleared', 'success');
                    updateStepStatus('step-clear', 'complete');
                    break;
                    
                case 'store':
                    updateStepStatus('step-store', 'running');
                    log(`Storing API key in localStorage...`, 'info');
                    localStorage.setItem('apiKey', apiKey);
                    log('API key stored successfully', 'success');
                    updateStepStatus('step-store', 'complete');
                    break;
                    
                case 'verify':
                    updateStepStatus('step-verify', 'running');
                    log('Verifying localStorage contents...', 'info');
                    const storedKey = localStorage.getItem('apiKey');
                    const storedToken = localStorage.getItem('authToken');
                    
                    log(`localStorage.apiKey: ${storedKey ? storedKey.substring(0, 10) + '...' : 'null'}`, 'info');
                    log(`localStorage.authToken: ${storedToken ? 'EXISTS' : 'null'}`, 'info');
                    
                    if (storedKey === apiKey && !storedToken) {
                        log('Storage verification passed ‚úÖ', 'success');
                        updateStepStatus('step-verify', 'complete');
                    } else {
                        log('Storage verification failed ‚ùå', 'error');
                        updateStepStatus('step-verify', 'failed');
                    }
                    break;
                    
                case 'request':
                    updateStepStatus('step-request', 'running');
                    log('Testing API request with API key...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/health`;
                        const requestHeaders = {
                            'x-api-key': apiKey,
                            'Content-Type': 'application/json'
                        };
                        
                        // Log request details
                        log('--- REQUEST ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: GET`, 'info');
                        log(`Headers:`, 'info');
                        Object.entries(requestHeaders).forEach(([key, value]) => {
                            if (key.toLowerCase() === 'x-api-key') {
                                log(`  ${key}: ${value.substring(0, 10)}...`, 'info');
                            } else {
                                log(`  ${key}: ${value}`, 'info');
                            }
                        });
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'GET',
                            headers: requestHeaders
                        });
                        const endTime = Date.now();
                        
                        // Log response details
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        // Log response headers
                        log('Response Headers:', 'info');
                        response.headers.forEach((value, key) => {
                            log(`  ${key}: ${value}`, 'info');
                        });
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2), 'info');
                        
                        if (response.ok) {
                            updateStepStatus('step-request', 'complete');
                            showStatus('apiKeyStatus', 'API Key authentication working!', 'success');
                            log('‚úÖ API Key authentication successful', 'success');
                        } else {
                            updateStepStatus('step-request', 'failed');
                            showStatus('apiKeyStatus', `API request failed: ${response.status}`, 'error');
                            log('‚ùå API Key authentication failed', 'error');
                        }
                    } catch (error) {
                        log('--- REQUEST ERROR ---', 'error');
                        log(`Error Type: ${error.name}`, 'error');
                        log(`Error Message: ${error.message}`, 'error');
                        log(`Stack Trace: ${error.stack}`, 'error');
                        updateStepStatus('step-request', 'failed');
                        showStatus('apiKeyStatus', `Request failed: ${error.message}`, 'error');
                    }
                    break;
                    
                case 'auth-request':
                    updateStepStatus('step-auth-request', 'running');
                    log('Testing authenticated endpoint with API key...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/users`;
                        const requestHeaders = {
                            'x-api-key': apiKey,
                            'Content-Type': 'application/json'
                        };
                        
                        // Log request details
                        log('--- AUTHENTICATED REQUEST ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: GET`, 'info');
                        log(`Headers:`, 'info');
                        Object.entries(requestHeaders).forEach(([key, value]) => {
                            if (key.toLowerCase() === 'x-api-key') {
                                log(`  ${key}: ${value.substring(0, 10)}...`, 'info');
                            } else {
                                log(`  ${key}: ${value}`, 'info');
                            }
                        });
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'GET',
                            headers: requestHeaders
                        });
                        const endTime = Date.now();
                        
                        // Log response details
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        // Log response headers
                        log('Response Headers:', 'info');
                        response.headers.forEach((value, key) => {
                            log(`  ${key}: ${value}`, 'info');
                        });
                        
                        let data;
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            data = await response.json();
                            log('Response Body:', 'info');
                            log(JSON.stringify(data, null, 2).substring(0, 1000) + '...', 'info');
                        } else {
                            data = await response.text();
                            log('Response Body (text):', 'info');
                            log(data.substring(0, 500) + '...', 'info');
                        }
                        
                        if (response.ok) {
                            updateStepStatus('step-auth-request', 'complete');
                            log('‚úÖ Authenticated endpoint access successful', 'success');
                            
                            // Additional validation
                            if (data && data.data && Array.isArray(data.data)) {
                                log(`Found ${data.data.length} users`, 'success');
                            }
                        } else if (response.status === 401) {
                            updateStepStatus('step-auth-request', 'failed');
                            log('‚ùå Authentication failed - API key not accepted', 'error');
                        } else if (response.status === 403) {
                            updateStepStatus('step-auth-request', 'failed');
                            log('‚ùå Authorization failed - insufficient permissions', 'error');
                        } else {
                            updateStepStatus('step-auth-request', 'failed');
                            log(`‚ùå Request failed with status ${response.status}`, 'error');
                        }
                    } catch (error) {
                        log('--- REQUEST ERROR ---', 'error');
                        log(`Error Type: ${error.name}`, 'error');
                        log(`Error Message: ${error.message}`, 'error');
                        if (error.cause) {
                            log(`Error Cause: ${error.cause}`, 'error');
                        }
                        updateStepStatus('step-auth-request', 'failed');
                    }
                    break;
            }
        }
        
        async function testApiKeyFlow() {
            log('Starting complete API Key authentication flow test', 'info');
            showStatus('apiKeyStatus', 'Running complete flow test...', 'info');
            
            // Reset all steps
            ['setup', 'clear', 'store', 'verify', 'request', 'auth-request'].forEach(step => {
                updateStepStatus(`step-${step}`, 'pending');
            });
            
            // Run each step with delay
            const steps = ['setup', 'clear', 'store', 'verify', 'request', 'auth-request'];
            for (const step of steps) {
                await testApiKeyStep(step);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('API Key flow test completed', 'success');
        }
        
        // JWT test functions
        let jwtToken = null;
        
        async function testJwtStep(step) {
            const email = document.getElementById('jwtEmail').value;
            const password = document.getElementById('jwtPassword').value;
            const projectId = document.getElementById('jwtProjectId').value;
            const apiUrl = document.getElementById('apiUrl').value;
            
            log(`Starting JWT test step: ${step}`, 'info');
            
            switch(step) {
                case 'clear':
                    updateStepStatus('jwt-step-clear', 'running');
                    log('Clearing existing authentication...', 'info');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('apiKey');
                    jwtToken = null;
                    log('localStorage and token state cleared', 'success');
                    updateStepStatus('jwt-step-clear', 'complete');
                    break;
                    
                case 'login':
                    updateStepStatus('jwt-step-login', 'running');
                    log('Attempting JWT login with correct password...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/auth/login`;
                        const requestBody = {
                            email,
                            password,
                            ...(projectId && { projectId })
                        };
                        
                        // Log request
                        log('--- LOGIN REQUEST (CORRECT PASSWORD) ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: POST`, 'info');
                        log(`Body: ${JSON.stringify(requestBody, null, 2)}`, 'info');
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        const endTime = Date.now();
                        
                        // Log response
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2), 'info');
                        
                        if (response.ok && data.data?.accessToken) {
                            jwtToken = data.data.accessToken;
                            localStorage.setItem('authToken', jwtToken);
                            
                            // Decode token to show payload
                            try {
                                const parts = jwtToken.split('.');
                                const payload = JSON.parse(atob(parts[1]));
                                log('Token Payload:', 'info');
                                log(JSON.stringify(payload, null, 2), 'info');
                            } catch (e) {
                                log('Could not decode token', 'error');
                            }
                            
                            updateStepStatus('jwt-step-login', 'complete');
                            showStatus('jwtStatus', 'Login successful!', 'success');
                            log('‚úÖ JWT login successful', 'success');
                        } else {
                            updateStepStatus('jwt-step-login', 'failed');
                            showStatus('jwtStatus', `Login failed: ${data.message || response.statusText}`, 'error');
                            log('‚ùå JWT login failed', 'error');
                        }
                    } catch (error) {
                        log('--- LOGIN ERROR ---', 'error');
                        log(`Error: ${error.message}`, 'error');
                        updateStepStatus('jwt-step-login', 'failed');
                        showStatus('jwtStatus', `Login error: ${error.message}`, 'error');
                    }
                    break;
                    
                case 'login-wrong':
                    log('Testing JWT login with WRONG password (security test)...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/auth/login`;
                        const requestBody = {
                            email,
                            password: 'WrongPassword123!', // Intentionally wrong password
                            ...(projectId && { projectId })
                        };
                        
                        // Log request
                        log('--- LOGIN REQUEST (WRONG PASSWORD) ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: POST`, 'info');
                        log(`Body: ${JSON.stringify(requestBody, null, 2)}`, 'info');
                        log('üîí SECURITY TEST: This should fail with 401 Unauthorized', 'info');
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        const endTime = Date.now();
                        
                        // Log response
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.status === 401 ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2), 'info');
                        
                        if (response.status === 401 && data.error === 'Invalid credentials') {
                            log('‚úÖ SECURITY TEST PASSED: Wrong password correctly rejected', 'success');
                            showStatus('jwtStatus', 'Security test passed: Wrong password rejected', 'success');
                        } else if (response.ok) {
                            log('‚ùå SECURITY VULNERABILITY: Wrong password was accepted!', 'error');
                            showStatus('jwtStatus', 'SECURITY RISK: Wrong password accepted!', 'error');
                        } else {
                            log(`‚ö†Ô∏è Unexpected response: ${response.status}`, 'error');
                            showStatus('jwtStatus', `Unexpected response: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        log('--- LOGIN ERROR ---', 'error');
                        log(`Error: ${error.message}`, 'error');
                        showStatus('jwtStatus', `Security test error: ${error.message}`, 'error');
                    }
                    break;
                    
                case 'verify-token':
                    updateStepStatus('jwt-step-verify-token', 'running');
                    log('Verifying JWT token storage...', 'info');
                    
                    const storedToken = localStorage.getItem('authToken');
                    const storedApiKey = localStorage.getItem('apiKey');
                    
                    log(`localStorage.authToken: ${storedToken ? 'EXISTS (length: ' + storedToken.length + ')' : 'null'}`, 'info');
                    log(`localStorage.apiKey: ${storedApiKey ? 'EXISTS' : 'null'}`, 'info');
                    log(`In-memory token: ${jwtToken ? 'EXISTS' : 'null'}`, 'info');
                    
                    if (storedToken === jwtToken && !storedApiKey) {
                        log('Token verification passed ‚úÖ', 'success');
                        updateStepStatus('jwt-step-verify-token', 'complete');
                    } else {
                        log('Token verification failed ‚ùå', 'error');
                        updateStepStatus('jwt-step-verify-token', 'failed');
                    }
                    break;
                    
                case 'profile':
                    updateStepStatus('jwt-step-profile', 'running');
                    log('Getting user profile...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/auth/profile`;
                        
                        log('--- PROFILE REQUEST ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: GET`, 'info');
                        log(`Authorization: Bearer ${jwtToken ? jwtToken.substring(0, 20) + '...' : 'null'}`, 'info');
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const endTime = Date.now();
                        
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2), 'info');
                        
                        if (response.ok && data.data) {
                            updateStepStatus('jwt-step-profile', 'complete');
                            log('‚úÖ Profile retrieved successfully', 'success');
                            log(`User: ${data.data.email}`, 'success');
                            log(`Permissions: ${data.data.permissions?.length || 0}`, 'success');
                        } else {
                            updateStepStatus('jwt-step-profile', 'failed');
                            log('‚ùå Failed to get profile', 'error');
                        }
                    } catch (error) {
                        log('--- PROFILE ERROR ---', 'error');
                        log(`Error: ${error.message}`, 'error');
                        updateStepStatus('jwt-step-profile', 'failed');
                    }
                    break;
                    
                case 'auth-test':
                    updateStepStatus('jwt-step-auth-test', 'running');
                    log('Testing authenticated endpoint with JWT...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/projects`;
                        
                        log('--- AUTHENTICATED REQUEST ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: GET`, 'info');
                        log(`Authorization: Bearer ${jwtToken ? jwtToken.substring(0, 20) + '...' : 'null'}`, 'info');
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${jwtToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const endTime = Date.now();
                        
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2).substring(0, 1000) + '...', 'info');
                        
                        if (response.ok) {
                            updateStepStatus('jwt-step-auth-test', 'complete');
                            log('‚úÖ Authenticated request successful', 'success');
                            if (Array.isArray(data.data)) {
                                log(`Found ${data.data.length} projects`, 'success');
                            }
                        } else {
                            updateStepStatus('jwt-step-auth-test', 'failed');
                            log(`‚ùå Request failed: ${response.status}`, 'error');
                        }
                    } catch (error) {
                        log('--- REQUEST ERROR ---', 'error');
                        log(`Error: ${error.message}`, 'error');
                        updateStepStatus('jwt-step-auth-test', 'failed');
                    }
                    break;
                    
                case 'logout':
                    updateStepStatus('jwt-step-logout', 'running');
                    log('Logging out...', 'info');
                    
                    localStorage.removeItem('authToken');
                    jwtToken = null;
                    
                    const afterLogout = localStorage.getItem('authToken');
                    if (!afterLogout) {
                        log('‚úÖ Logout successful - token cleared', 'success');
                        updateStepStatus('jwt-step-logout', 'complete');
                        showStatus('jwtStatus', 'Logged out successfully', 'info');
                    } else {
                        log('‚ùå Logout failed - token still present', 'error');
                        updateStepStatus('jwt-step-logout', 'failed');
                    }
                    break;
            }
        }
        
        async function testJwtFlow() {
            log('Starting complete JWT authentication flow test', 'info');
            showStatus('jwtStatus', 'Running complete flow test...', 'info');
            
            // Reset all steps
            ['clear', 'login', 'verify-token', 'profile', 'auth-test', 'logout'].forEach(step => {
                updateStepStatus(`jwt-step-${step}`, 'pending');
            });
            
            // Run each step with delay
            const steps = ['clear', 'login', 'verify-token', 'profile', 'auth-test', 'logout'];
            for (const step of steps) {
                await testJwtStep(step);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('JWT flow test completed', 'success');
        }
        
        // Azure AD test functions
        let azureToken = null;
        let authState = crypto.randomUUID(); // For CSRF protection
        
        async function testAzureStep(step) {
            const tenantId = document.getElementById('azureTenantId').value;
            const clientId = document.getElementById('azureClientId').value;
            const redirectUri = document.getElementById('azureRedirectUri').value;
            const authCode = document.getElementById('azureAuthCode').value;
            const apiUrl = document.getElementById('apiUrl').value;
            
            log(`Starting Azure AD test step: ${step}`, 'info');
            
            switch(step) {
                case 'clear':
                    updateStepStatus('azure-step-clear', 'running');
                    log('Clearing existing authentication...', 'info');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('apiKey');
                    azureToken = null;
                    log('Auth cleared', 'success');
                    updateStepStatus('azure-step-clear', 'complete');
                    break;
                    
                case 'auth-url':
                    updateStepStatus('azure-step-auth-url', 'running');
                    log('Generating Azure AD authorization URL...', 'info');
                    
                    if (!tenantId || !clientId) {
                        log('‚ùå Missing Tenant ID or Client ID', 'error');
                        updateStepStatus('azure-step-auth-url', 'failed');
                        showStatus('azureStatus', 'Please enter Tenant ID and Client ID', 'error');
                        return;
                    }
                    
                    // Build authorization URL
                    const authUrl = new URL(`https://login.microsoftonline.com/${tenantId}/oauth2/v2.0/authorize`);
                    authState = crypto.randomUUID();
                    
                    authUrl.searchParams.append('client_id', clientId);
                    authUrl.searchParams.append('response_type', 'code');
                    authUrl.searchParams.append('redirect_uri', redirectUri);
                    authUrl.searchParams.append('response_mode', 'fragment');
                    authUrl.searchParams.append('scope', 'openid profile email User.Read');
                    authUrl.searchParams.append('state', authState);
                    
                    const fullUrl = authUrl.toString();
                    
                    log('--- AUTHORIZATION URL ---', 'info');
                    log(`Tenant ID: ${tenantId}`, 'info');
                    log(`Client ID: ${clientId}`, 'info');
                    log(`Redirect URI: ${redirectUri}`, 'info');
                    log(`State: ${authState}`, 'info');
                    log(`Scopes: openid profile email User.Read`, 'info');
                    log(`Full URL: ${fullUrl}`, 'info');
                    
                    // Show URL in UI
                    document.getElementById('authUrlText').value = fullUrl;
                    document.getElementById('azureAuthUrl').style.display = 'block';
                    
                    updateStepStatus('azure-step-auth-url', 'complete');
                    showStatus('azureStatus', 'Auth URL generated! Click "Open in Browser" to authenticate.', 'success');
                    log('‚úÖ Auth URL generated successfully', 'success');
                    break;
                    
                case 'exchange':
                    updateStepStatus('azure-step-exchange', 'running');
                    log('Exchanging authorization code for token...', 'info');
                    
                    if (!authCode) {
                        log('‚ùå No authorization code provided', 'error');
                        updateStepStatus('azure-step-exchange', 'failed');
                        showStatus('azureStatus', 'Please paste the authorization code', 'error');
                        return;
                    }
                    
                    try {
                        const requestUrl = `${apiUrl}/auth/azure/callback`;
                        const requestBody = {
                            code: authCode,
                            redirectUri: redirectUri
                        };
                        
                        log('--- CODE EXCHANGE REQUEST ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: POST`, 'info');
                        log(`Body: ${JSON.stringify(requestBody, null, 2)}`, 'info');
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(requestBody)
                        });
                        const endTime = Date.now();
                        
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2), 'info');
                        
                        if (response.ok && data.data?.access_token) {
                            azureToken = data.data.access_token;
                            localStorage.setItem('authToken', azureToken);
                            
                            log('‚úÖ Code exchange successful', 'success');
                            log(`Token type: ${data.data.token_type}`, 'success');
                            log(`Expires in: ${data.data.expires_in} seconds`, 'success');
                            
                            updateStepStatus('azure-step-exchange', 'complete');
                            showStatus('azureStatus', 'Token received successfully!', 'success');
                        } else {
                            updateStepStatus('azure-step-exchange', 'failed');
                            showStatus('azureStatus', `Exchange failed: ${data.error || response.statusText}`, 'error');
                            log('‚ùå Code exchange failed', 'error');
                        }
                    } catch (error) {
                        log('--- EXCHANGE ERROR ---', 'error');
                        log(`Error: ${error.message}`, 'error');
                        updateStepStatus('azure-step-exchange', 'failed');
                        showStatus('azureStatus', `Exchange error: ${error.message}`, 'error');
                    }
                    break;
                    
                case 'verify':
                    updateStepStatus('azure-step-verify', 'running');
                    log('Verifying Azure AD token storage...', 'info');
                    
                    const storedToken = localStorage.getItem('authToken');
                    const storedApiKey = localStorage.getItem('apiKey');
                    
                    log(`localStorage.authToken: ${storedToken ? 'EXISTS (Azure token)' : 'null'}`, 'info');
                    log(`localStorage.apiKey: ${storedApiKey ? 'EXISTS' : 'null'}`, 'info');
                    log(`In-memory token: ${azureToken ? 'EXISTS' : 'null'}`, 'info');
                    
                    if (storedToken === azureToken && !storedApiKey) {
                        log('Token verification passed ‚úÖ', 'success');
                        updateStepStatus('azure-step-verify', 'complete');
                    } else {
                        log('Token verification failed ‚ùå', 'error');
                        updateStepStatus('azure-step-verify', 'failed');
                    }
                    break;
                    
                case 'profile':
                    updateStepStatus('azure-step-profile', 'running');
                    log('Getting user profile with Azure token...', 'info');
                    
                    try {
                        const requestUrl = `${apiUrl}/auth/profile`;
                        
                        log('--- PROFILE REQUEST ---', 'info');
                        log(`URL: ${requestUrl}`, 'info');
                        log(`Method: GET`, 'info');
                        log(`Authorization: Bearer ${azureToken ? azureToken.substring(0, 20) + '...' : 'null'}`, 'info');
                        
                        const startTime = Date.now();
                        const response = await fetch(requestUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${azureToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const endTime = Date.now();
                        
                        log('--- RESPONSE ---', 'info');
                        log(`Status: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        log(`Time: ${endTime - startTime}ms`, 'info');
                        
                        const data = await response.json();
                        log('Response Body:', 'info');
                        log(JSON.stringify(data, null, 2), 'info');
                        
                        if (response.ok && data.data) {
                            updateStepStatus('azure-step-profile', 'complete');
                            log('‚úÖ Profile retrieved successfully', 'success');
                            log(`User: ${data.data.email}`, 'success');
                            log(`Name: ${data.data.name || 'N/A'}`, 'success');
                            log(`Permissions: ${data.data.permissions?.length || 0}`, 'success');
                        } else {
                            updateStepStatus('azure-step-profile', 'failed');
                            log('‚ùå Failed to get profile', 'error');
                        }
                    } catch (error) {
                        log('--- PROFILE ERROR ---', 'error');
                        log(`Error: ${error.message}`, 'error');
                        updateStepStatus('azure-step-profile', 'failed');
                    }
                    break;
            }
        }
        
        async function testAzureFlow() {
            log('Starting complete Azure AD authentication flow test', 'info');
            showStatus('azureStatus', 'Running Azure AD flow test...', 'info');
            
            // Note: This flow requires manual intervention
            log('‚ö†Ô∏è Azure AD flow requires manual steps:', 'info');
            log('1. Generate auth URL', 'info');
            log('2. Open URL in browser and authenticate', 'info');
            log('3. Copy the code from callback URL', 'info');
            log('4. Paste code and continue with exchange', 'info');
            
            // Just run the first step
            await testAzureStep('clear');
            await new Promise(resolve => setTimeout(resolve, 500));
            await testAzureStep('auth-url');
            
            showStatus('azureStatus', 'Please complete manual authentication steps', 'info');
        }
        
        function copyAuthUrl() {
            const authUrl = document.getElementById('authUrlText').value;
            navigator.clipboard.writeText(authUrl).then(() => {
                log('Auth URL copied to clipboard', 'success');
            });
        }
        
        function openAuthUrl() {
            const authUrl = document.getElementById('authUrlText').value;
            window.open(authUrl, '_blank');
            log('Opened auth URL in new window', 'info');
            log('After authenticating, copy the code from the callback URL', 'info');
        }
        
        // Debug utilities
        function clearDebugLog() {
            const debugWindow = document.getElementById('debugWindow');
            debugWindow.innerHTML = `
                <div class="debug-entry info">
                    <span class="timestamp">[${new Date().toLocaleTimeString()}]</span>
                    Debug log cleared.
                </div>
            `;
        }
        
        function copyDebugLog() {
            const debugWindow = document.getElementById('debugWindow');
            const text = debugWindow.innerText;
            navigator.clipboard.writeText(text).then(() => {
                log('Debug log copied to clipboard', 'success');
            });
        }
        
        function downloadDebugLog() {
            const debugWindow = document.getElementById('debugWindow');
            const text = debugWindow.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `auth-test-debug-${new Date().toISOString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('Debug log downloaded', 'success');
        }
    </script>
</body>
</html>